<!DOCTYPE html>
<html lang="pt-br">
{% load static %}
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Portal da Papelaria{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#6d28d9" />
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <link rel="icon" href="{% static 'img/icon.png' %}">
    <link rel="apple-touch-icon" href="{% static 'img/icon.png' %}">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <style>
      :root {
        --grad: linear-gradient(135deg, #6d28d9, #a855f7);
      }
      * { box-sizing: border-box; }
      body {
        font-family: "Inter", system-ui, sans-serif;
        background: #eef6ff;
        margin: 0;
        color: #0f172a;
      }
      main {
        min-height: calc(100vh - 88px);
        margin-bottom: 88px;
        padding: 1rem 1rem 2rem;
      }
      .app-header {
        position: sticky;
        top: 0;
        z-index: 20;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        gap: 1rem;
        background: var(--grad);
        color: #fff;
        box-shadow: 0 20px 35px rgba(108, 51, 217, 0.35);
      }
      .app-header--catalogo {
        flex-direction: column;
        align-items: stretch;
        gap: 0.65rem;
        position: relative;
        padding-top: 1.35rem;
      }
      .header-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      .header-search-wrapper {
        width: 100%;
      }
      .header-brand {
        text-decoration: none;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.04em;
      }
      .header-logo {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.18);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .header-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .header-brand .brand-text {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
      }
      .header-brand .brand-title {
        font-size: 1.1rem;
        margin: 0;
      }
      .header-brand small {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        opacity: 0.85;
        margin: 0;
      }
      .header-center { width: 100%; }
      .header-center form { display: flex; align-items: center; }
      .header-search {
        border: none;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        padding: 0.55rem 1.25rem;
        border-radius: 999px;
        font-size: 0.95rem;
        width: 100%;
      }
      .header-search::placeholder { color: #fff; opacity: 0.9; }
      .header-actions { display: flex; align-items: center; gap: 0.75rem; }
      .header-search-wrapper form { width: 100%; }
      .header-actions .header-logout-form { margin-left: auto; }
      .header-logout {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 42px; height: 42px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        text-decoration: none;
        border: 1px solid rgba(255, 255, 255, 0.35);
      }
      .header-logout svg { width: 20px; height: 20px; stroke: currentColor; }
      .header-cart {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.6rem 1.25rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        text-decoration: none;
        font-weight: 600;
      }
      .header-cart__badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px; height: 26px;
        border-radius: 50%;
        background: #ede9fe;
        color: #6d28d9;
        font-size: 0.75rem;
        font-weight: 700;
        border: 1px solid rgba(109, 40, 217, 0.35);
      }
      .header-cart__label { text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.75rem; }
      @media (max-width: 640px) {
        .header-top-row { justify-content: flex-start; }
        .app-header--catalogo .header-cart {
          position: absolute;
          top: 1.2rem;
          right: 0.5rem;
          padding: 0.3rem 0.65rem;
        }
        .app-header--catalogo .header-cart__label {
          display: none;
        }
        .app-header--catalogo .header-cart__badge {
          width: 24px;
          height: 24px;
        }
      }
      .app-header--system { justify-content: space-between; align-items: center; }
      .app-header--system .header-actions { margin-left: auto; }

      .cart-modal { position: fixed; inset: 0; background: rgba(15,23,42,0.55); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 30; }
      .cart-modal.is-open { display: flex; }
      .cart-modal__panel { background: #fff; border-radius: 32px; width: min(600px, 100%); max-height: 90vh; overflow-y: auto; box-shadow: 0 40px 100px rgba(15,23,42,0.35); padding: 2rem; position: relative; }
      .cart-modal__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
      .cart-modal__header h3 { margin: 0; font-size: 1.5rem; }
      .cart-modal__close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #475569; }
      .cart-modal__body { display: flex; flex-direction: column; gap: 1rem; }
      .cart-modal__item { display: flex; gap: 1rem; align-items: center; }
      .cart-modal__item-image { width: 70px; height: 70px; border-radius: 20px; background-size: cover; background-position: center; flex-shrink: 0; }
      .cart-modal__item-info h4 { margin: 0; font-size: 1rem; }
      .cart-modal__item-info p { margin: 0; font-size: 0.9rem; color: #475569; }
      .cart-modal__item-actions { display: flex; gap: 0.35rem; margin-top: 0.45rem; align-items: center; }
      .cart-modal__item-actions button { border: none; border-radius: 12px; padding: 0.4rem 0.85rem; font-weight: 600; cursor: pointer; }
      .cart-modal__item-actions .cart-link { background: rgba(236,72,153,0.08); color: #ec4899; border: 1px solid rgba(236,72,153,0.4); }
      .cart-modal__item-actions .cart-link.danger { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.5); color: #b91c1c; }
      .catalog-icon-btn.small { width: 32px; height: 32px; padding: 0; font-size: 1.1rem; }
      .cart-modal__summary { margin-top: 1.25rem; font-weight: 700; color: #db2777; text-align: right; }
      .cart-modal__cta { margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
      .cart-modal__cta a { flex: 1; text-align: center; text-decoration: none; padding: 0.9rem 1.1rem; border-radius: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
      .cart-modal__cta .btn-primary { background: linear-gradient(120deg, #ec4899, #d946ef); color: #fff; }
      .cart-modal__cta .btn-secondary { border: 1px solid rgba(15, 23, 42, 0.18); background: transparent; color: #0f172a; }
      .add-confirm-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 40;
      }
      .add-confirm-modal.is-visible {
        display: flex;
      }
      .add-confirm-modal__panel {
        background: #fff;
        padding: 1.25rem;
        border-radius: 24px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: min(320px, 90%);
        align-items: center;
        text-align: center;
      }
      .add-confirm-modal__actions {
        display: flex;
        gap: 0.75rem;
        width: 100%;
      }

      .app-footer { position: fixed; bottom: 0; width: 100%; background: var(--grad); border-top: none; padding: 0.75rem 0.5rem; box-shadow: 0 -20px 50px rgba(78,70,255,0.4); }
      .footer-nav { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; padding: 0 0.75rem; }
      .footer-nav { scrollbar-width: none; -ms-overflow-style: none; }
      .footer-nav::-webkit-scrollbar { display: none; }
      .footer-tab--mobile-catalog { display: none; }
      .footer-tab { text-decoration: none; color: #fff; font-weight: 600; display: flex; align-items: center; gap: 0.65rem; padding: 0.7rem 1rem; border-radius: 999px; transition: transform 0.2s ease, box-shadow 0.2s ease; font-size: 0.95rem; }
      .footer-tab span { text-transform: uppercase; letter-spacing: 0.1em; }
      .footer-tab svg { width: 20px; height: 20px; }
      .footer-tab.active { background: rgba(255, 255, 255, 0.25); box-shadow: 0 8px 25px rgba(15, 23, 42, 0.3); }
      .footer-tab:hover { transform: translateY(-1px); background: rgba(255, 255, 255, 0.15); }

      @media (max-width: 900px) {
        .app-header:not(.app-header--system) { flex-direction: column; align-items: stretch; }
        .header-center { width: 100%; order: 3; }
        .header-actions { width: 100%; justify-content: flex-start; order: 2; flex-wrap: wrap; gap: 0.5rem; }
        .header-brand { order: 1; }
        .app-header--system { flex-direction: row; align-items: center; }
        .app-header--system .header-brand { order: 1; }
        .app-header--system .header-actions { width: auto; order: 2; margin-left: auto; flex-wrap: nowrap; }
        .cart-modal__panel { width: 100%; max-width: 520px; padding: 1.5rem; }
        .cart-modal__item { align-items: flex-start; }
        .app-header { position: static; box-shadow: none; }
      }
      @media (max-width: 600px) {
        main { padding: 0.75rem 0.6rem 2.5rem; margin-bottom: 96px; }
        .app-header { padding: 0.75rem 1rem; }
        .footer-nav { gap: 0.5rem; justify-content: flex-start; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 0.4rem; -webkit-overflow-scrolling: touch; }
        .footer-nav { scrollbar-width: none; -ms-overflow-style: none; }
        .footer-nav::-webkit-scrollbar { display: none; }
        .footer-tab { flex: 0 0 auto; justify-content: center; font-size: 0.9rem; padding: 0.65rem 0.75rem; }
        .footer-tab--mobile-catalog { display: inline-flex; }
        .cart-modal__panel { padding: 1.1rem; border-radius: 18px; }
        .cart-modal__item { gap: 0.75rem; }
        .cart-modal__item-image { width: 56px; height: 56px; border-radius: 16px; }
      }
      @media (max-width: 420px) {
        .footer-nav { justify-content: flex-start; gap: 0.4rem; }
        .footer-tab { flex: 0 0 auto; white-space: nowrap; }
        .header-cart__label { display: none; }
        .header-cart { padding: 0.55rem 0.9rem; }
      }
    </style>
  </head>
  <body>
{% with resolver=request.resolver_match %}
{% block navigation %}
    {% if resolver and resolver.namespace == "catalogo" %}
    <header class="app-header app-header--catalogo">
      <div class="header-top-row">
        <a href="{% url 'catalogo:home' %}" class="header-brand">
          <span class="header-logo">
            <img src="{% static 'img/logo-papelaria-ribeiro.png' %}" alt="Logo Papelaria Ribeiro" />
          </span>
          <span class="brand-text">
            <span class="brand-title">Papelaria Ribeiro</span>
            <small>Catalogo &amp; Pedidos</small>
          </span>
        </a>
        <div class="header-actions">
          <a href="{% url 'catalogo:carrinho' %}" class="header-cart">
            <span class="header-cart__badge">{{ cart_total_items|default:0 }}</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 6h15l-1.5 8H8z"/><circle cx="10" cy="20" r="2"/><circle cx="17" cy="20" r="2"/>
            </svg>
            <span class="header-cart__label">Carrinho</span>
          </a>
        </div>
      </div>
      <div class="header-search-wrapper">
        <form action="{% url 'catalogo:home' %}" method="get">
          <input class="header-search" type="search" name="q" placeholder="Buscar produtos..." />
        </form>
      </div>
    </header>
  {% elif request.user.is_authenticated %}
    <header class="app-header app-header--system">
      <a href="{% url 'core:configuracao' %}" class="header-brand">
        <span class="header-logo">
          <img src="{% static 'img/logo-papelaria-ribeiro.png' %}" alt="Logo Papelaria Ribeiro" />
        </span>
        <span class="brand-text">
          <span class="brand-title">Papelaria Ribeiro</span>
          <small>Area administrativa</small>
        </span>
      </a>
      <div class="header-actions">
        <form method="post" action="{% url 'logout' %}" class="header-logout-form">
          {% csrf_token %}
          <button type="submit" class="header-logout" aria-label="Sair">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h5"/>
              <path d="M15 17l5-5-5-5"/>
              <path d="M9 12h11"/>
            </svg>
          </button>
        </form>
      </div>
    </header>
  {% endif %}
{% endblock %}
    <main>{% block content %}{% endblock %}</main>
{% block footer %}
  {% if resolver and resolver.namespace == "catalogo" %}
    <div class="cart-modal" id="cartModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="cart-modal__panel">
        <div class="cart-modal__header">
          <div>
            <p class="cart-label">Carrinho</p>
            <h3>Resumo rapido</h3>
          </div>
          <button class="cart-modal__close" type="button" data-cart-close aria-label="Fechar carrinho">&times;</button>
        </div>
        <div class="cart-modal__body">
          {% if cart_items %}
            {% for item in cart_items %}
              <div class="cart-modal__item" data-cart-id="{{ item.produto_id }}" data-cart-key="{{ item.item_key }}">
                <div class="cart-modal__item-image" style="background-image: url('{{ item.imagem|default:'' }}');"></div>
                <div class="cart-modal__item-info">
                  <h4>{{ item.nome }}</h4>
                  <p>{{ item.quantidade }} x R$ {{ item.preco|floatformat:2 }}</p>
                  <div class="cart-modal__item-actions">
                    <form class="ajax-cart" method="post" action="{% url 'catalogo:carrinho_adicionar' item.produto_id %}">
                      {% csrf_token %}
                      <input type="hidden" name="destination" value="stay">
                      <input type="hidden" name="next" value="{{ request.path }}">
                      <button type="submit" class="catalog-icon-btn small" aria-label="Adicionar mais unidades">+</button>
                    </form>
                    <form class="ajax-cart" method="post" action="{% url 'catalogo:carrinho_atualizar' item.produto_id %}">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.path }}">
                      <input type="hidden" name="cart_action" value="decrement">
                      <input type="hidden" name="item_key" value="{{ item.item_key }}">
                      <button type="submit" class="cart-link" aria-label="Diminuir quantidade">- 1</button>
                    </form>
                    <form class="ajax-cart" method="post" action="{% url 'catalogo:carrinho_atualizar' item.produto_id %}">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.path }}">
                      <input type="hidden" name="cart_action" value="remove">
                      <input type="hidden" name="item_key" value="{{ item.item_key }}">
                      <button type="submit" class="cart-link danger" aria-label="Remover produto">Remover</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
            <p class="cart-modal__summary">Total: R$ {{ cart_total|floatformat:2 }}</p>
            <div class="cart-modal__cta">
              <a href="{% url 'catalogo:home' %}" class="btn-secondary" data-cart-close>Continuar comprando</a>
              <a href="{% url 'catalogo:checkout' %}" class="btn-primary" data-cart-close>Finalizar</a>
            </div>
          {% else %}
            <p class="empty-state" style="margin:0;">Seu carrinho esta vazio.</p>
            <div class="cart-modal__cta">
              <a href="{% url 'catalogo:home' %}" class="btn-secondary" data-cart-close>Voltar ao catalogo</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

  {% if resolver and resolver.namespace == "catalogo" %}
    <div class="add-confirm-modal" id="addConfirmModal" aria-hidden="true">
      <div class="add-confirm-modal__panel">
        <p>Produto adicionado ao carrinho.</p>
        <div class="add-confirm-modal__actions">
          <button type="button" data-add-confirm="continue" class="btn-secondary">Continuar comprando</button>
          <button type="button" data-add-confirm="finish" class="btn-primary">Finalizar pedido</button>
        </div>
      </div>
    </div>
  {% endif %}

  {% if resolver and resolver.namespace != "accounts" and request.user.is_authenticated %}
    <footer class="app-footer">
      <nav class="footer-nav">
        <a href="{% url 'pedidos:lista' %}" class="footer-tab {% if '/pedidos/' in request.path %}active{% endif %}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
            <path d="M4 7h16v4H4zM4 17h16v4H4zM4 12h16v4H4z"/>
          </svg>
          <span>Pedidos</span>
        </a>
        <a href="{% url 'produtos:lista' %}" class="footer-tab {% if '/produtos/' in request.path %}active{% endif %}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
            <path d="M5 4h14l-2 14H7z"/><path d="M10 9h4"/>
          </svg>
          <span>Produtos</span>
        </a>
        <a href="{% url 'core:configuracao' %}" class="footer-tab {% if '/configuracao/' in request.path %}active{% endif %}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
            <circle cx="12" cy="12" r="2"/><path d="M4.5 12h15M12 4.5v15"/>
          </svg>
          <span>Configuracao</span>
        </a>
        <a href="{% url 'catalogo:home' %}" class="footer-tab footer-tab--mobile-catalog">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
            <path d="M4 4h16v16H4z"/><path d="M4 9h16M9 4v16"/>
          </svg>
          <span>Catalogo Online</span>
        </a>
      </nav>
    </footer>
  {% endif %}
{% endblock %}
{% endwith %}
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/service-worker.js", { scope: "/" }).catch((err) => {
            console.warn("SW registration failed", err);
          });
        });
      }
      (function () {
        const modal = document.getElementById("cartModal");
        const trigger = document.querySelector(".header-cart");
        const closeButtons = modal?.querySelectorAll("[data-cart-close]");
        const cartBody = modal?.querySelector(".cart-modal__body");
        const cartSummary = modal?.querySelector(".cart-modal__summary");
        const catalogHomeUrl = "{% url 'catalogo:home' %}";
        const checkoutUrl = "{% url 'catalogo:checkout' %}";
        const addConfirmModal = document.getElementById("addConfirmModal");
        const addConfirmContinue = addConfirmModal?.querySelector("[data-add-confirm='continue']");
        const addConfirmFinish = addConfirmModal?.querySelector("[data-add-confirm='finish']");
        let pendingAddConfirm = false;

        function bindCloseLinks() {
          modal
            .querySelectorAll("[data-cart-close]")
            .forEach((element) => {
              element.addEventListener("click", function (event) {
                const target = event.currentTarget;
                const isLink = target.tagName === "A" && target.getAttribute("href");
                if (!isLink) event.preventDefault();
                hideCart();
              });
            });
        }

        if (!modal || !trigger) return;

        function showCart() {
          modal.classList.add("is-open");
          modal.setAttribute("aria-hidden", "false");
        }
        function hideCart() {
          modal.classList.remove("is-open");
          modal.setAttribute("aria-hidden", "true");
        }

        function showAddConfirmModal() {
          if (!addConfirmModal) return;
          addConfirmModal.classList.add("is-visible");
          addConfirmModal.setAttribute("aria-hidden", "false");
        }

        function hideAddConfirmModal() {
          if (!addConfirmModal) return;
          addConfirmModal.classList.remove("is-visible");
          addConfirmModal.setAttribute("aria-hidden", "true");
        }

        addConfirmContinue?.addEventListener("click", (event) => {
          event.preventDefault();
          hideAddConfirmModal();
        });
        addConfirmFinish?.addEventListener("click", (event) => {
          event.preventDefault();
          hideAddConfirmModal();
          window.location.href = checkoutUrl;
        });

        trigger.addEventListener("click", function (event) {
          event.preventDefault();
          showCart();
        });

        closeButtons?.forEach(function (element) {
          element.addEventListener("click", function (event) {
            const target = event.currentTarget;
            const isLink = target.tagName === "A" && target.getAttribute("href");
            if (!isLink) event.preventDefault();
            hideCart();
          });
        });

        modal.addEventListener("click", function (event) {
          if (event.target === modal) hideCart();
        });
        bindCloseLinks();

        function buildEmptyState() {
          if (!cartBody) return;
          cartBody.innerHTML = `
            <p class="empty-state" style="margin:0;">Seu carrinho esta vazio.</p>
            <div class="cart-modal__cta">
              <a href="${catalogHomeUrl}" class="btn-secondary" data-cart-close>Voltar ao catalogo</a>
            </div>
          `;
          bindCloseLinks();
        }

        function updateCartDisplay(data) {
          const badge = document.querySelector(".header-cart__badge");
          if (badge) badge.textContent = data.total_items;
          if (!cartBody) return;
          if (data.total_items === 0) {
            buildEmptyState();
            return;
          }
          if (cartSummary) {
            cartSummary.textContent = `Total: R$ ${parseFloat(data.total).toFixed(2)}`;
          }
          const itemsMap = new Map(
            data.items.map((item) => [item.item_key || item.produto_id.toString(), item])
          );
          const rows = modal.querySelectorAll(".cart-modal__item");
          rows.forEach((row) => {
            const key = row.getAttribute("data-cart-key");
            if (!key || !itemsMap.has(key)) {
              row.remove();
              return;
            }
            const item = itemsMap.get(key);
            const quantityEl = row.querySelector(".cart-modal__item-info p");
            if (quantityEl) {
              quantityEl.textContent = `${item.quantidade} x R$ ${parseFloat(item.preco).toFixed(2)}`;
            }
          });
        }

        function attachAjaxForms() {
          modal.querySelectorAll("form.ajax-cart").forEach((form) => {
            form.addEventListener("submit", async function (event) {
              event.preventDefault();
              pendingAddConfirm = form.dataset.cartAction === "add";
              const formData = new FormData(form);
              const response = await fetch(form.action, {
                method: form.method.toUpperCase(),
                headers: { "X-Requested-With": "XMLHttpRequest" },
                body: formData,
                credentials: "same-origin",
              });
              if (!response.ok) return;
              const data = await response.json();
              updateCartDisplay(data);
              if (pendingAddConfirm && addConfirmModal) {
                showAddConfirmModal();
              }
              pendingAddConfirm = false;
            });
          });
        }

        attachAjaxForms();
      })();
    </script>
  </body>
</html>
