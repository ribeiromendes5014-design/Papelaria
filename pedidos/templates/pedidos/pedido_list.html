{% extends "base.html" %}

{% block content %}
  <style>
    .orders-dashboard {
      min-height: 100vh;
      background: #ece5ff;
      padding: 2.75rem 2.5rem 3rem;
    }

    .orders-header {
      background: #fff;
      border-radius: 28px;
      padding: 1.5rem 2.25rem;
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.1);
      margin-bottom: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      align-items: center;
    }

    .orders-header h1 {
      margin: 0;
      font-size: 2.25rem;
      color: #0f172a;
    }

    .orders-header small {
      color: #6b7280;
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }

    .orders-header .search-wrapper {
      display: flex;
      align-items: center;
      background: #f5f7ff;
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.15);
      padding: 0.6rem 1rem;
      box-shadow: inset 0 2px 6px rgba(15, 23, 42, 0.08);
    }

    .orders-header .search-wrapper svg {
      width: 20px;
      height: 20px;
    }

    .orders-header .search-wrapper input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 0.95rem;
      color: #0f172a;
      margin-left: 0.7rem;
    }

    .orders-header input:focus {
      outline: none;
    }

    .status-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .status-card {
      background: #fff;
      padding: 1.25rem;
      border-radius: 18px;
      box-shadow: 0 25px 55px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      border-top: 4px solid rgba(124, 58, 237, 0.8);
    }

    .status-card strong {
      font-size: 1.7rem;
      color: #0f172a;
    }

    .status-card span {
      color: #475569;
      font-size: 0.95rem;
    }

    .filters-grid {
      background: #fff;
      border-radius: 20px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 25px 50px rgba(15, 23, 42, 0.08);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      align-items: start;
      margin-bottom: 2rem;
    }

    .filters-grid input,
    .filters-grid select {
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.15);
      padding: 0.85rem 1rem;
      background: #f5f7ff;
      font-size: 0.95rem;
      color: #0f172a;
      width: 100%;
    }

    .filter-actions {
      display: flex;
      gap: 0.6rem;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .filter-actions button {
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.35rem;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      transition: transform 0.2s ease;
    }

    .filter-actions .primary {
      background: linear-gradient(120deg, #4f46e5, #a855f7);
    }

    .filter-actions .secondary {
      background: #0f172a;
      opacity: 0.85;
    }

    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.25rem;
    }

    .order-card {
      background: #fff;
      border-radius: 24px;
      padding: 1.75rem;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 280px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .order-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.12);
    }

    .order-card h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
    }

    .status-pill {
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid transparent;
    }

    .status-pill.pending {
      color: #b91c1c;
      background: #fee2e2;
      border-color: #ef4444;
    }

    .status-pill.processing {
      color: #0c4a6e;
      background: #e0f2fe;
      border-color: #0284c7;
    }

    .status-pill.finished {
      color: #047857;
      background: #d1fae5;
      border-color: #10b981;
    }

    .order-meta {
      color: #475569;
      font-size: 0.92rem;
      display: grid;
      gap: 0.35rem;
    }

    .order-total {
      font-size: 1.35rem;
      font-weight: 800;
      color: #111827;
    }

    .order-summary {
      background: #f4f6ff;
      border-radius: 16px;
      padding: 1rem;
      font-size: 0.9rem;
      color: #0f172a;
      line-height: 1.4;
    }

    .order-summary ul {
      margin: 0.4rem 0 0;
      padding-left: 1.2rem;
    }

    .order-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1200;
    }

    .order-modal.is-open {
      display: flex;
    }

    .order-modal__content {
      background: #fff;
      border-radius: 28px;
      max-width: 880px;
      width: min(880px, 100%);
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 35px 90px rgba(15, 23, 42, 0.25);
      position: relative;
      padding: 2rem;
      display: grid;
      gap: 1.5rem;
    }

    .order-modal__close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #0f172a;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.2);
    }

    .order-modal__header {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: flex-start;
    }

    .order-modal__status {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-weight: 700;
      background: #eff6ff;
      color: #0f172a;
      border: 1px solid #cbd5e1;
    }

    .order-modal__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .order-modal__card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 1rem;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .order-modal__thumbs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    .order-modal__thumb {
      border: 1px dashed rgba(15, 23, 42, 0.15);
      border-radius: 12px;
      padding: 0.5rem;
      background: #fff;
      display: grid;
      gap: 0.35rem;
      align-content: start;
    }

    .order-modal__thumb img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 10px;
    }

    .order-modal__items {
      display: grid;
      gap: 0.5rem;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .order-modal__item {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      background: #fff;
      padding: 0.75rem 0.85rem;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .order-modal__item strong {
      display: block;
    }

    .order-modal__footer {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .order-modal__cta {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: #22c55e;
      color: #fff;
      padding: 0.85rem 1.3rem;
      border-radius: 12px;
      font-weight: 700;
      text-decoration: none;
      border: none;
      cursor: pointer;
      box-shadow: 0 12px 24px rgba(34, 197, 94, 0.35);
    }

    .order-toast {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.3);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 10;
    }

    .order-toast.is-visible {
      opacity: 1;
    }

    .order-toast.error {
      background: #dc2626;
      box-shadow: 0 12px 24px rgba(220, 38, 38, 0.35);
    }

    .order-modal__cta.danger {
      background: #ef4444;
      box-shadow: 0 12px 24px rgba(239, 68, 68, 0.35);
    }

    .order-modal__image-viewer {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1300;
      padding: 1rem;
    }

    .order-modal__image-viewer.is-open {
      display: flex;
    }

    .order-modal__image-box {
      position: relative;
      background: #0b1220;
      border-radius: 12px;
      max-width: 90vw;
      max-height: 90vh;
      padding: 1rem;
      display: grid;
      gap: 0.75rem;
      justify-items: center;
    }

    .order-modal__image-box img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 10px;
    }

    .order-modal__image-close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #0f172a;
      color: #fff;
      border: none;
      border-radius: 999px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 1.1rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
    }

    @media (max-width: 720px) {
      .orders-dashboard {
        padding: 1.5rem 1rem 2rem;
      }

      .filters-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .orders-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <section class="orders-dashboard">
    <header class="orders-header">
      <div>
        <small>Pedidos</small>
        <h1>Painel de pedidos</h1>
      </div>
      <div class="search-wrapper">
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="1.5" />
          <line x1="16.5" y1="16.5" x2="21" y2="21" stroke="#64748b" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        <input type="text" placeholder="Buscar por pedido, cliente ou produto" />
      </div>
    </header>

    <div class="status-board">
      {% if status_counts %}
        {% for stat in status_counts %}
          <div class="status-card">
            <strong>{{ stat.count }}</strong>
            <span>{{ stat.label }}</span>
          </div>
        {% endfor %}
      {% else %}
        <div class="status-card">
          <strong>0</strong>
          <span>Pedidos</span>
        </div>
      {% endif %}
    </div>

    <div class="filters-grid">
      <input type="date" name="start_date" placeholder="De" />
      <input type="date" name="end_date" placeholder="Até" />
      <select name="status_filter">
        <option value="">Todos os status</option>
        {% for value, label in pedidos.model.STATUS_CHOICES %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
      <input type="text" name="search" placeholder="Buscar ID, cliente ou descrição" />
      <div class="filter-actions">
        <button class="secondary" type="button">Limpar</button>
        <button class="primary" type="button">Aplicar filtros</button>
      </div>
    </div>

    <div class="orders-grid">
      {% for pedido in pedidos %}
        <article
          class="order-card"
          role="button"
          tabindex="0"
          data-order-card
          data-id="{{ pedido.id }}"
          data-cliente="{{ pedido.cliente|default_if_none:'' }}"
          data-telefone="{{ pedido.telefone|default_if_none:'' }}"
          data-total="{{ pedido.total }}"
          data-status="{{ pedido.get_status_display }}"
          data-status-code="{{ pedido.status }}"
          data-data="{{ pedido.created_on|date:'d/m/Y H:i' }}"
          data-nome-capa="{{ pedido.nome_capa|default_if_none:''|escape }}"
          data-capa="{{ pedido.capa_url|default_if_none:''|default:'' }}"
          data-contra-capa="{{ pedido.contra_capa_url|default_if_none:''|default:'' }}"
          data-whatsapp="{{ request.tenant.whatsapp|default:'' }}"
        >
          <div>
            <h3>
              #{{ pedido.id }} - {{ pedido.cliente }}
              <span class="status-pill {{ pedido.status }}">
                {{ pedido.get_status_display }}
              </span>
            </h3>
            <div class="order-meta">
              <div><strong>Data:</strong> {{ pedido.created_on|date:"d/m/Y H:i" }}</div>
              <div><strong>Cliente:</strong> {{ pedido.cliente }}</div>
              <div><strong>Total:</strong> R$ {{ pedido.total }}</div>
            </div>
          </div>
          <div class="order-summary">
            <strong>Resumo do pedido</strong>
            <ul>
              {% for item in pedido.itens.all %}
                <li>{{ item.produto }} – {{ item.quantidade }} × R$ {{ item.preco_unitario }}</li>
              {% empty %}
                <li>Nenhum item cadastrado.</li>
              {% endfor %}
            </ul>
            <script type="application/json" class="order-items-data">
[
{% for item in pedido.itens.all %}
  {
    "produto": "{{ item.produto|escapejs }}",
    "quantidade": {{ item.quantidade }},
    "preco_unitario": "{{ item.preco_unitario }}",
    "imagem": "{{ item.imagem|default_if_none:''|escapejs }}"
  }{% if not forloop.last %},{% endif %}
{% endfor %}
]
            </script>
          </div>
        </article>
      {% empty %}
        <p>Nenhum pedido encontrado.</p>
      {% endfor %}
    </div>

    <div class="order-modal" id="orderModal" aria-hidden="true">
      <div class="order-modal__content">
        <div class="order-toast" data-order-toast aria-hidden="true"></div>
        <button type="button" class="order-modal__close" data-order-modal-close aria-label="Fechar">×</button>
        <div data-order-modal-body></div>
      </div>
    </div>
    <div class="order-modal__image-viewer" data-image-viewer aria-hidden="true">
      <div class="order-modal__image-box">
        <button type="button" class="order-modal__image-close" data-image-close aria-label="Fechar visualização">×</button>
        <img src="" alt="Visualização da capa" data-image-preview />
        <a href="#" download class="order-modal__cta" data-image-download>Baixar imagem</a>
      </div>
    </div>
  </section>

  <script>
    (function () {
      const modal = document.getElementById("orderModal");
      const modalBody = modal?.querySelector("[data-order-modal-body]");
      const closeBtn = modal?.querySelector("[data-order-modal-close]");
      const toast = modal?.querySelector("[data-order-toast]");
      const csrfToken = "{{ csrf_token }}";
      const statusUpdateBase = "{% url 'pedidos:status' 0 %}".replace(/0\/?$/, "");
      const deleteBase = "{% url 'pedidos:excluir' 0 %}".replace(/0\/?$/, "");
      const statusOptions = [
        {% for value, label in pedidos.model.STATUS_CHOICES %}
          { value: "{{ value }}", label: "{{ label }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
      const imageViewer = document.querySelector("[data-image-viewer]");
      const imagePreview = document.querySelector("[data-image-preview]");
      const imageDownload = document.querySelector("[data-image-download]");
      const imageClose = document.querySelector("[data-image-close]");

      function showToast(message, isError = false) {
        if (!toast) return;
        toast.textContent = message;
        toast.classList.toggle("error", isError);
        toast.classList.add("is-visible");
        toast.removeAttribute("aria-hidden");
        setTimeout(() => {
          toast?.classList.remove("is-visible");
          toast?.setAttribute("aria-hidden", "true");
        }, 2000);
      }

      function phoneToWaLink(raw) {
        if (!raw) return "";
        const digits = (raw || "").replace(/\D/g, "");
        if (!digits) return "";
        return `https://wa.me/${digits}`;
      }

      function renderModal(card) {
        if (!modal || !modalBody) return;
        const itemsScript = card.querySelector(".order-items-data");
        let items = [];
        if (itemsScript?.textContent) {
          try {
            items = JSON.parse(itemsScript.textContent);
          } catch (err) {
            items = [];
          }
        }

        const capa = card.dataset.capa;
        const contra = card.dataset.contraCapa;
        const whatsapp = card.dataset.whatsapp;
        const waLink = phoneToWaLink(whatsapp);

        const itemsMarkup =
          items.length === 0
            ? "<li class='order-modal__item'><span>Nenhum item cadastrado.</span></li>"
            : items
                .map(
                  (item) => `
              <li class="order-modal__item">
                <div>
                  <strong>${item.produto}</strong>
                  <span>${item.quantidade} un.</span>
                </div>
                <div>
                  R$ ${item.preco_unitario}
                </div>
              </li>
            `
                )
                .join("");

        modalBody.innerHTML = `
          <header class="order-modal__header">
            <div>
              <p style="margin:0;color:#6b7280;">Pedido #${card.dataset.id}</p>
              <h2 style="margin:0;">${card.dataset.cliente || "Cliente"}</h2>
              <p style="margin:0.25rem 0;color:#475569;">${card.dataset.data}</p>
            </div>
            <div class="order-modal__status">${card.dataset.status}</div>
          </header>
          <div class="order-modal__grid">
            <div class="order-modal__card">
              <strong>Itens</strong>
              <ul class="order-modal__items">
                ${itemsMarkup}
              </ul>
            </div>
            <div class="order-modal__card">
              <strong>Detalhes</strong>
              <p style="margin:0.3rem 0;">Telefone: <b>${card.dataset.telefone || "Nao informado"}</b></p>
              <p style="margin:0.3rem 0;">Nome/Frase na capa: <b>${card.dataset.nomeCapa || "-"}</b></p>
              <p style="margin:0.3rem 0;">Total: <b>R$ ${card.dataset.total}</b></p>
              <div style="margin-top:0.8rem; display:grid; gap:0.4rem;">
                <label style="font-weight:600; color:#334155;">Status do pedido</label>
                <select data-order-status-select style="border:1px solid rgba(15,23,42,0.12); border-radius:10px; padding:0.6rem 0.75rem;">
                  ${statusOptions
                    .map(
                      (opt) =>
                        `<option value="${opt.value}" ${opt.value === card.dataset.statusCode ? "selected" : ""}>${opt.label}</option>`
                    )
                    .join("")}
                </select>
                <button type="button" data-order-status-save class="order-modal__cta" style="background:#6366f1; box-shadow:0 12px 24px rgba(99,102,241,0.35); justify-content:center;">Atualizar status</button>
              </div>
            </div>
          </div>
          <div class="order-modal__card">
            <strong>Arquivos enviados</strong>
            <div class="order-modal__thumbs">
              <div class="order-modal__thumb">
                <span>Capa</span>
                ${
                  capa
                    ? `<img src="${capa}" alt="Capa do pedido" data-image-open="${capa}" /> <button type="button" class="order-modal__cta" style="background:#0ea5e9; box-shadow:0 10px 20px rgba(14,165,233,0.3); justify-content:center; margin-top:0.35rem;" data-image-open="${capa}">Ver em tela cheia</button>`
                    : "<small>Sem arquivo</small>"
                }
              </div>
              <div class="order-modal__thumb">
                <span>Contra capa</span>
                ${
                  contra
                    ? `<img src="${contra}" alt="Contra capa do pedido" data-image-open="${contra}" /> <button type="button" class="order-modal__cta" style="background:#0ea5e9; box-shadow:0 10px 20px rgba(14,165,233,0.3); justify-content:center; margin-top:0.35rem;" data-image-open="${contra}">Ver em tela cheia</button>`
                    : "<small>Sem arquivo</small>"
                }
              </div>
            </div>
          </div>
          <footer class="order-modal__footer">
            <div>
              <strong>Pedido #${card.dataset.id}</strong>
              <div style="color:#475569;">Status: ${card.dataset.status}</div>
            </div>
            ${
              waLink
                ? `<a class="order-modal__cta" href="${waLink}" target="_blank" rel="noreferrer">Abrir WhatsApp</a>`
                : ""
            }
            <button type="button" class="order-modal__cta danger" data-order-delete>Excluir pedido</button>
          </footer>
        `;
      }

      async function updateStatus(card, newStatus) {
        if (!newStatus) return;
        const endpoint = `${statusUpdateBase}${card.dataset.id}/`;
        const body = new URLSearchParams({ status: newStatus });
        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body,
          credentials: "same-origin",
        });
        if (!response.ok) {
          showToast("Nao foi possivel atualizar o status.", true);
          return;
        }
        const data = await response.json();
        card.dataset.status = data.status_label;
        card.dataset.statusCode = data.status;
        const pill = card.querySelector(".status-pill");
        if (pill) {
          pill.textContent = data.status_label;
          pill.className = `status-pill ${data.status}`;
        }
        renderModal(card);
        bindModalActions(card);
        showToast(`Status atualizado para ${data.status_label}.`);
      }

      function openModal(card) {
        renderModal(card);
        bindModalActions(card);
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }

      function bindModalActions(card) {
        const select = modalBody?.querySelector("[data-order-status-select]");
        const saveBtn = modalBody?.querySelector("[data-order-status-save]");
        const deleteBtn = modalBody?.querySelector("[data-order-delete]");
        if (select) {
          select.value = card.dataset.statusCode || "";
        }
        if (saveBtn && select) {
          saveBtn.addEventListener("click", () => updateStatus(card, select.value));
        }
        if (deleteBtn) {
          deleteBtn.addEventListener("click", () => deleteOrder(card));
        }
        modalBody?.querySelectorAll("[data-image-open]").forEach((el) => {
          el.addEventListener("click", () => openImage(el.getAttribute("data-image-open")));
        });
      }

      function closeModal() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }

      async function deleteOrder(card) {
        const confirmed = window.confirm("Deseja excluir este pedido?");
        if (!confirmed) return;
        const endpoint = `${deleteBase}${card.dataset.id}/`;
        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
          },
          credentials: "same-origin",
        });
        if (!response.ok) {
          showToast("Não foi possível excluir.", true);
          return;
        }
        const data = await response.json();
        if (data.ok) {
          const cardEl = document.querySelector(`[data-order-card][data-id="${card.dataset.id}"]`);
          cardEl?.remove();
          closeModal();
          showToast("Pedido excluído.");
          const grid = document.querySelector(".orders-grid");
          if (grid && grid.children.length === 0) {
            grid.innerHTML = "<p>Nenhum pedido encontrado.</p>";
          }
        }
      }

      modal?.addEventListener("click", (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
      closeBtn?.addEventListener("click", closeModal);
      imageClose?.addEventListener("click", closeImage);
      imageViewer?.addEventListener("click", (event) => {
        if (event.target === imageViewer) {
          closeImage();
        }
      });

      document.querySelectorAll("[data-order-card]").forEach((card) => {
        card.addEventListener("click", () => openModal(card));
        card.addEventListener("keypress", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            openModal(card);
          }
        });
      });

      function openImage(url) {
        if (!url || !imageViewer || !imagePreview || !imageDownload) return;
        imagePreview.src = url;
        imageDownload.href = url;
        imageViewer.classList.add("is-open");
        imageViewer.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }

      function closeImage() {
        if (!imageViewer || !imagePreview) return;
        imagePreview.src = "";
        imageViewer.classList.remove("is-open");
        imageViewer.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }
    })();
  </script>
{% endblock %}
